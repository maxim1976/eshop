{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "è³¼ç‰©è»Š / Shopping Cart" %} - {{ block.super }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">
        {% trans "è³¼ç‰©è»Š / Shopping Cart" %}
    </h1>
    
    {% if cart_items %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Cart Items / è³¼ç‰©è»Šå•†å“ -->
        <div class="lg:col-span-2">
            {% for item in cart_items %}
            <div class="bg-white rounded-lg shadow p-6 mb-4 cart-item" data-item-id="{{ item.id }}">
                <div class="flex gap-4">
                    <!-- Product Image / å•†å“åœ–ç‰‡ -->
                    <div class="w-24 h-24 flex-shrink-0">
                        {% if item.product.images.first %}
                        <img src="{{ item.product.images.first.image.url }}" 
                             alt="{{ item.product.name_en }} / {{ item.product.name }}" 
                             class="w-full h-full object-cover rounded">
                        {% else %}
                        <div class="w-full h-full bg-gray-200 rounded flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Product Info / å•†å“è³‡è¨Š -->
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg text-gray-900 mb-1">
                            <a href="{% url 'products:product_detail' item.product.slug %}" class="hover:text-blue-600">
                                {{ item.product.name }}
                            </a>
                        </h3>
                        {% if item.product.name_en %}
                        <p class="text-sm text-gray-500 mb-2">{{ item.product.name_en }}</p>
                        {% endif %}
                        
                        {% if item.variant %}
                        <p class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">{% trans "è¦æ ¼ / Variant" %}:</span> 
                            {{ item.variant.name }}
                            {% if item.variant.name_en %}
                            <span class="text-gray-500">/ {{ item.variant.name_en }}</span>
                            {% endif %}
                        </p>
                        {% endif %}
                        
                        <p class="text-sm text-gray-500 mb-2">
                            <span class="font-medium">{% trans "å•†å“ç·¨è™Ÿ / SKU" %}:</span> 
                            {{ item.product.sku }}
                        </p>
                        
                        <!-- Price / åƒ¹æ ¼ -->
                        <div class="mb-3">
                            <span class="text-lg font-bold text-gray-900">
                                NT$ {{ item.get_price|floatformat:0 }}
                            </span>
                            <span class="text-xs text-gray-500 ml-2">
                                {% trans "å–®åƒ¹ / Unit Price" %}
                            </span>
                        </div>
                        
                        <!-- Quantity Controls / æ•¸é‡æ§åˆ¶ -->
                        <div class="flex items-center gap-4">
                            <div class="flex items-center border border-gray-300 rounded">
                                <button onclick="updateQuantity({{ item.id }}, -1)" 
                                        class="px-3 py-1 hover:bg-gray-100 transition"
                                        aria-label="{% trans 'æ¸›å°‘æ•¸é‡ / Decrease quantity' %}">
                                    -
                                </button>
                                <input type="number" 
                                       value="{{ item.quantity }}" 
                                       min="1" 
                                       max="{{ item.available_stock }}" 
                                       class="w-16 text-center border-x border-gray-300 py-1" 
                                       id="qty-{{ item.id }}" 
                                       onchange="updateQuantity({{ item.id }}, 0, this.value)"
                                       aria-label="{% trans 'å•†å“æ•¸é‡ / Product quantity' %}">
                                <button onclick="updateQuantity({{ item.id }}, 1)" 
                                        class="px-3 py-1 hover:bg-gray-100 transition"
                                        aria-label="{% trans 'å¢åŠ æ•¸é‡ / Increase quantity' %}">
                                    +
                                </button>
                            </div>
                            
                            <button onclick="removeItem({{ item.id }})" 
                                    class="text-red-600 hover:text-red-700 text-sm font-medium transition"
                                    aria-label="{% trans 'ç§»é™¤å•†å“ / Remove item' %}">
                                ğŸ—‘ï¸ {% trans "ç§»é™¤ / Remove" %}
                            </button>
                        </div>
                        
                        <!-- Stock Status / åº«å­˜ç‹€æ…‹ -->
                        {% with status=item.stock_status %}
                            {% if status.level == 'error' %}
                            <p class="text-red-600 text-sm mt-2 font-medium">
                                âŒ {{ status.message }}
                            </p>
                            {% elif status.level == 'warning' %}
                            <p class="text-orange-600 text-sm mt-2 font-medium">
                                âš ï¸ {{ status.message }} ({% trans "åƒ…å‰© / Only" %} {{ status.available }} {% trans "ä»¶ / items" %})
                            </p>
                            {% elif status.level == 'info' %}
                            <p class="text-blue-600 text-sm mt-2">
                                â„¹ï¸ {{ status.message }}: {{ status.available }} {% trans "ä»¶ / items" %}
                            </p>
                            {% endif %}
                        {% endwith %}
                    </div>
                    
                    <!-- Item Subtotal / å°è¨ˆ -->
                    <div class="text-right">
                        <p class="text-sm text-gray-500 mb-1">
                            {% trans "å°è¨ˆ / Subtotal" %}
                        </p>
                        <p class="text-lg font-bold text-gray-900 item-subtotal" data-item-id="{{ item.id }}">
                            NT$ {{ item.get_total_price|floatformat:0 }}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Clear Cart Button / æ¸…ç©ºè³¼ç‰©è»ŠæŒ‰éˆ• -->
            <div class="mt-4">
                <button onclick="clearCart()" 
                        class="text-red-600 hover:text-red-700 font-medium transition"
                        aria-label="{% trans 'æ¸…ç©ºè³¼ç‰©è»Š / Clear cart' %}">
                    ğŸ—‘ï¸ {% trans "æ¸…ç©ºè³¼ç‰©è»Š / Clear Cart" %}
                </button>
            </div>
        </div>
        
        <!-- Order Summary / è¨‚å–®æ‘˜è¦ -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow p-6 sticky top-4">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    {% trans "è¨‚å–®æ‘˜è¦ / Order Summary" %}
                </h2>
                
                <div class="space-y-3 mb-4 pb-4 border-b">
                    <div class="flex justify-between text-gray-700">
                        <span>{% trans "å•†å“å°è¨ˆ / Subtotal" %} ({{ item_count }} {% trans "ä»¶ / items" %})</span>
                        <span id="cart-subtotal">NT$ {{ subtotal|floatformat:0 }}</span>
                    </div>
                    <div class="flex justify-between text-gray-700">
                        <span>{% trans "é‹è²» / Shipping" %}</span>
                        <span id="cart-shipping">
                            {% if shipping_fee == 0 %}
                                <span class="text-green-600 font-medium">
                                    âœ“ {% trans "å…é‹è²» / Free Shipping" %}
                                </span>
                            {% else %}
                                NT$ {{ shipping_fee|floatformat:0 }}
                            {% endif %}
                        </span>
                    </div>
                    
                    {% if shipping_remaining > 0 %}
                    <div class="bg-blue-50 border border-blue-200 rounded p-3">
                        <p class="text-sm text-blue-800 mb-2">
                            ğŸ’¡ {% blocktrans with amount=shipping_remaining|floatformat:0 %}
                            å†è³¼è²· NT$ {{ amount }} å³å¯äº«å…é‹è²»
                            {% endblocktrans %}
                        </p>
                        <p class="text-xs text-blue-600 mb-2">
                            {% blocktrans with amount=shipping_remaining|floatformat:0 %}
                            Add NT$ {{ amount }} more for free shipping
                            {% endblocktrans %}
                        </p>
                        <div class="w-full bg-blue-200 rounded-full h-2">
                            {% widthratio subtotal free_shipping_threshold 100 as progress_percent %}
                            <div class="bg-blue-600 h-2 rounded-full transition-all" 
                                 style="width: {{ progress_percent }}%"
                                 role="progressbar"
                                 aria-valuenow="{{ progress_percent }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100"></div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="flex justify-between text-xl font-bold text-gray-900 mb-6">
                    <span>{% trans "ç¸½è¨ˆ / Total" %}</span>
                    <span id="cart-total">NT$ {{ total|floatformat:0 }}</span>
                </div>
                
                <a href="{% url 'orders:checkout' %}" 
                   class="block w-full bg-blue-600 text-white text-center py-3 rounded-lg font-semibold hover:bg-blue-700 transition mb-3"
                   aria-label="{% trans 'å‰å¾€çµå¸³ / Proceed to checkout' %}">
                    {% trans "å‰å¾€çµå¸³ / Proceed to Checkout" %}
                </a>
                
                <a href="{% url 'products:product_list' %}" 
                   class="block w-full bg-gray-100 text-gray-700 text-center py-3 rounded-lg font-medium hover:bg-gray-200 transition"
                   aria-label="{% trans 'ç¹¼çºŒè³¼ç‰© / Continue shopping' %}">
                    {% trans "ç¹¼çºŒè³¼ç‰© / Continue Shopping" %}
                </a>
                
                <!-- Security Badges / å®‰å…¨æ¨™ç«  -->
                <div class="mt-6 pt-6 border-t">
                    <div class="flex items-center justify-center gap-2 text-sm text-gray-600">
                        <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                        </svg>
                        <span>{% trans "å®‰å…¨çµå¸³ / Secure Checkout" %}</span>
                    </div>
                    <p class="text-xs text-center text-gray-500 mt-2">
                        {% trans "ç¬¦åˆå°ç£å€‹è³‡æ³• PDPA è¦ç¯„ / PDPA Compliant" %}
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- Empty Cart / ç©ºè³¼ç‰©è»Š -->
    <div class="text-center py-16">
        <svg class="w-24 h-24 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">
            {% trans "è³¼ç‰©è»Šæ˜¯ç©ºçš„ / Your Cart is Empty" %}
        </h2>
        <p class="text-gray-600 mb-2">
            {% trans "é‚„æ²’æœ‰æ·»åŠ ä»»ä½•å•†å“ / No items added yet" %}
        </p>
        <p class="text-sm text-gray-500 mb-6">
            {% trans "ç€è¦½æˆ‘å€‘çš„å•†å“ï¼Œé–‹å§‹è³¼ç‰©å§ï¼ / Browse our products and start shopping!" %}
        </p>
        <a href="{% url 'products:product_list' %}" 
           class="inline-block bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
           aria-label="{% trans 'é–‹å§‹è³¼ç‰© / Start shopping' %}">
            ğŸ›ï¸ {% trans "é–‹å§‹è³¼ç‰© / Start Shopping" %}
        </a>
    </div>
    {% endif %}
</div>

<script>
// CSRF Token Helper / CSRF ä»¤ç‰Œè¼”åŠ©å‡½æ•¸
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

/**
 * Update cart item quantity
 * æ›´æ–°è³¼ç‰©è»Šå•†å“æ•¸é‡
 * @param {number} itemId - Cart item ID / è³¼ç‰©è»Šé …ç›® ID
 * @param {number} change - Quantity change amount / æ•¸é‡è®ŠåŒ–
 * @param {number|null} newValue - New quantity value / æ–°æ•¸é‡å€¼
 */
function updateQuantity(itemId, change, newValue = null) {
    const input = document.getElementById(`qty-${itemId}`);
    let quantity = newValue !== null ? parseInt(newValue) : parseInt(input.value) + change;
    
    if (quantity < 1) quantity = 1;
    input.value = quantity;
    
    fetch(`/cart/update/${itemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ quantity: quantity })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update item subtotal / æ›´æ–°å•†å“å°è¨ˆ
            document.querySelector(`.item-subtotal[data-item-id="${itemId}"]`).textContent = 
                `NT$ ${Math.round(data.item_subtotal).toLocaleString()}`;
            
            // Update cart totals / æ›´æ–°è³¼ç‰©è»Šç¸½è¨ˆ
            document.getElementById('cart-total').textContent = 
                `NT$ ${Math.round(data.cart_total).toLocaleString()}`;
            document.getElementById('cart-subtotal').textContent = 
                `NT$ ${Math.round(data.cart_total).toLocaleString()}`;
            
            // Update navbar cart count / æ›´æ–°å°èˆªæ¬„è³¼ç‰©è»Šæ•¸é‡
            updateCartCount(data.cart_count);
        } else {
            alert(data.message);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error updating quantity / æ›´æ–°æ•¸é‡éŒ¯èª¤:', error);
        alert('{% trans "æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦ / Update failed, please try again" %}');
    });
}

/**
 * Remove item from cart
 * å¾è³¼ç‰©è»Šç§»é™¤å•†å“
 * @param {number} itemId - Cart item ID / è³¼ç‰©è»Šé …ç›® ID
 */
function removeItem(itemId) {
    if (!confirm('{% trans "ç¢ºå®šè¦ç§»é™¤æ­¤å•†å“å—ï¼Ÿ / Are you sure you want to remove this item?" %}')) {
        return;
    }
    
    fetch(`/cart/remove/${itemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove item from DOM / å¾ DOM ç§»é™¤å•†å“
            document.querySelector(`.cart-item[data-item-id="${itemId}"]`).remove();
            
            // Update navbar cart count / æ›´æ–°å°èˆªæ¬„è³¼ç‰©è»Šæ•¸é‡
            updateCartCount(data.cart_count);
            
            // Reload if cart is empty / å¦‚æœè³¼ç‰©è»Šç‚ºç©ºå‰‡é‡æ–°è¼‰å…¥
            if (data.cart_count === 0) {
                location.reload();
            } else {
                // Recalculate totals / é‡æ–°è¨ˆç®—ç¸½è¨ˆ
                location.reload();
            }
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error removing item / ç§»é™¤å•†å“éŒ¯èª¤:', error);
        alert('{% trans "ç§»é™¤å¤±æ•—ï¼Œè«‹é‡è©¦ / Remove failed, please try again" %}');
    });
}

/**
 * Clear all items from cart
 * æ¸…ç©ºè³¼ç‰©è»Šæ‰€æœ‰å•†å“
 */
function clearCart() {
    if (!confirm('{% trans "ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ / Are you sure you want to clear the cart?" %}')) {
        return;
    }
    
    fetch('/cart/clear/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error clearing cart / æ¸…ç©ºè³¼ç‰©è»ŠéŒ¯èª¤:', error);
        alert('{% trans "æ¸…ç©ºå¤±æ•—ï¼Œè«‹é‡è©¦ / Clear failed, please try again" %}');
    });
}

/**
 * Update cart count badge in navbar
 * æ›´æ–°å°èˆªæ¬„è³¼ç‰©è»Šæ•¸é‡æ¨™ç« 
 * @param {number} count - New cart item count / æ–°è³¼ç‰©è»Šå•†å“æ•¸é‡
 */
function updateCartCount(count) {
    const badge = document.querySelector('.cart-count-badge');
    if (badge) {
        badge.textContent = count;
        if (count === 0) {
            badge.classList.add('hidden');
        } else {
            badge.classList.remove('hidden');
        }
    }
}
</script>
{% endblock %}
